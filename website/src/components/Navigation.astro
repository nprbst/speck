---
/**
 * Navigation Component - Organic Theme
 * Warm header with gentle transitions and soft backdrop
 */

export interface NavLink {
  text: string;
  href: string;
  external?: boolean;
}

export interface Props {
  currentPath: string;
  links: NavLink[];
  logo: {
    src: string;
    alt: string;
    href: string;
  };
  mobileBreakpoint?: number;
  showDocsMenuToggle?: boolean;
}

const { currentPath, links, logo, mobileBreakpoint = 768, showDocsMenuToggle = false } = Astro.props;
---

<header class="site-header">
  <div class="container">
    <nav class="nav" aria-label="Main navigation">
      <a href={logo.href} class="logo-link" aria-label={logo.alt}>
        <svg class="logo" width="130" height="36" viewBox="0 0 130 36" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <text x="0" y="28" font-family="var(--font-logo), Georgia, serif" font-size="28" font-weight="700" fill="currentColor">Speck</text>
        </svg>
      </a>

      <!-- Navigation links -->
      <ul class="nav-links" data-nav-links>
        {
          links.map((link) => (
            <li class="nav-item">
              <a
                href={link.href}
                class:list={['nav-link', { active: currentPath === link.href }]}
                aria-current={currentPath === link.href ? 'page' : undefined}
                target={link.external ? '_blank' : undefined}
                rel={link.external ? 'noopener noreferrer' : undefined}
              >
                {link.text}
              </a>
            </li>
          ))
        }
      </ul>

      <div class="nav-actions">
        <!-- Docs sidebar toggle (mobile only, docs pages only) -->
        {showDocsMenuToggle && (
          <button
            class="docs-menu-toggle"
            aria-label="Toggle documentation menu"
            aria-expanded="false"
            data-sidebar-toggle
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="3" y1="12" x2="21" y2="12"></line>
              <line x1="3" y1="6" x2="21" y2="6"></line>
              <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
          </button>
        )}

        <!-- Theme toggle (tri-mode: system → light → dark) -->
        <button
          class="theme-toggle"
          aria-label="Toggle theme"
          data-theme-toggle
          title="Toggle theme"
        >
          <!-- Sun icon (shown when in light mode) -->
          <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
          </svg>
          <!-- Moon icon (shown when in dark mode) -->
          <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
          </svg>
          <!-- System icon (shown when following system preference) -->
          <svg class="icon-system" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
            <line x1="8" y1="21" x2="16" y2="21"></line>
            <line x1="12" y1="17" x2="12" y2="21"></line>
          </svg>
        </button>

        <!-- Mobile menu button -->
        <button
          class="mobile-menu-toggle"
          aria-label="Toggle mobile menu"
          aria-expanded="false"
          data-mobile-menu-toggle
        >
          <svg class="menu-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="none">
            <circle cx="12" cy="5" r="2"></circle>
            <circle cx="12" cy="12" r="2"></circle>
            <circle cx="12" cy="19" r="2"></circle>
          </svg>
          <svg class="close-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
    </nav>
  </div>
</header>

<style define:vars={{ mobileBreakpoint: `${mobileBreakpoint}px` }}>
  .site-header {
    position: sticky;
    top: 0;
    z-index: 50;
    border-bottom: 1px solid var(--color-border);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    transition: background-color var(--transition-normal), border-color var(--transition-normal);
  }

  /* Light mode background */
  [data-theme='light'] .site-header,
  :root:not([data-theme='dark']) .site-header {
    background-color: rgba(253, 251, 249, 0.85);
  }

  /* Dark mode background */
  [data-theme='dark'] .site-header {
    background-color: rgba(31, 28, 25, 0.9);
  }

  @media (prefers-color-scheme: dark) {
    :root:not([data-theme='light']) .site-header {
      background-color: rgba(31, 28, 25, 0.9);
    }
  }

  .nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 0;
    gap: 2rem;
  }

  .logo-link {
    display: flex;
    align-items: center;
    text-decoration: none;
    color: var(--color-text);
    transition: transform var(--transition-normal), opacity var(--transition-normal), color var(--transition-normal);
  }

  .logo-link:hover {
    transform: scale(1.02);
    opacity: 0.9;
  }

  .logo {
    height: 2rem;
    width: auto;
  }

  .nav-links {
    display: none; /* Hidden by default - shown by JS or desktop media query */
    list-style: none;
    gap: 0.5rem;
    margin: 0;
    padding: 0;
  }

  /* Desktop: show nav links inline */
  @media (min-width: 48.0625em) {
    .nav-links {
      display: flex;
    }
  }

  .nav-item {
    position: relative;
  }

  .nav-link {
    display: block;
    padding: 0.5rem 1rem;
    color: var(--color-text-secondary);
    text-decoration: none;
    font-weight: 500;
    border-radius: var(--radius-md);
    transition: color var(--transition-normal), background-color var(--transition-normal);
  }

  .nav-link:hover {
    color: var(--color-accent);
    background-color: var(--color-accent-subtle);
  }

  .nav-link.active {
    color: var(--color-accent);
    font-weight: 600;
    background-color: var(--color-accent-subtle);
  }

  /* Underline indicator for active link */
  .nav-link.active::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 1rem;
    right: 1rem;
    height: 2px;
    background: var(--color-accent);
    border-radius: var(--radius-full);
  }

  /* Nav actions container */
  .nav-actions {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  /* Theme toggle */
  .theme-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2.5rem;
    height: 2.5rem;
    cursor: pointer;
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    color: var(--color-text-secondary);
    transition: all var(--transition-normal);
  }

  .theme-toggle:hover {
    background: var(--color-hover);
    border-color: var(--color-accent-subtle);
    color: var(--color-accent);
  }

  .theme-toggle:active {
    transform: scale(0.95);
  }

  /* Theme toggle icons - controlled by data-theme-preference attribute on <html> */
  /* Using :global() to escape Astro's scoped CSS for parent selectors */
  .icon-sun,
  .icon-moon,
  .icon-system {
    display: none;
  }

  /* System preference (default): show system icon */
  .icon-system {
    display: block;
  }

  /* Light mode forced: show sun icon */
  :global([data-theme-preference='light']) .icon-sun {
    display: block;
  }
  :global([data-theme-preference='light']) .icon-system {
    display: none;
  }

  /* Dark mode forced: show moon icon */
  :global([data-theme-preference='dark']) .icon-moon {
    display: block;
  }
  :global([data-theme-preference='dark']) .icon-system {
    display: none;
  }

  /* Docs sidebar toggle (mobile only) */
  .docs-menu-toggle {
    display: none;
    align-items: center;
    justify-content: center;
    width: 2.5rem;
    height: 2.5rem;
    cursor: pointer;
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    color: var(--color-text-secondary);
    transition: all var(--transition-normal);
  }

  .docs-menu-toggle:hover {
    background: var(--color-hover);
    border-color: var(--color-accent-subtle);
    color: var(--color-accent);
  }

  .docs-menu-toggle:active {
    transform: scale(0.95);
  }

  .docs-menu-toggle[aria-expanded='true'] {
    background: var(--color-accent-subtle);
    border-color: var(--color-accent);
    color: var(--color-accent);
  }

  /* Mobile menu toggle - uses vertical dots icon (distinct from docs hamburger) */
  .mobile-menu-toggle {
    display: none;
    align-items: center;
    justify-content: center;
    width: 2.5rem;
    height: 2.5rem;
    cursor: pointer;
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: 0;
    color: var(--color-text-secondary);
    transition: all var(--transition-normal);
    flex-shrink: 0; /* Prevent button from being squished */
  }

  .mobile-menu-toggle:hover {
    background: var(--color-hover);
    border-color: var(--color-accent-subtle);
    color: var(--color-accent);
  }

  .mobile-menu-toggle:active {
    transform: scale(0.95);
  }

  /* Show menu icon by default, close icon when expanded */
  .mobile-menu-toggle .menu-icon {
    display: block;
  }

  .mobile-menu-toggle .close-icon {
    display: none;
  }

  .mobile-menu-toggle[aria-expanded='true'] .menu-icon {
    display: none;
  }

  .mobile-menu-toggle[aria-expanded='true'] .close-icon {
    display: block;
  }

  .mobile-menu-toggle[aria-expanded='true'] {
    background: var(--color-accent-subtle);
    border-color: var(--color-accent);
    color: var(--color-accent);
  }

  /* Mobile styles */
  @media (max-width: 48em) {
    .nav {
      flex-wrap: wrap;
    }

    .docs-menu-toggle {
      display: flex;
    }

    .mobile-menu-toggle {
      display: flex !important;
    }

    /* Mobile nav-links: part of header flow, expands when open */
    .nav-links {
      display: none !important;
      flex-direction: column;
      gap: 0.25rem;
      width: 100%;
      order: 10; /* Push to end (new row) */
      padding: 0.5rem 0;
    }

    .nav-links[data-menu-open='true'] {
      display: flex !important;
      animation: fadeInDown 0.2s var(--ease-out-soft);
    }

    .nav-item {
      width: 100%;
    }

    .nav-link {
      display: block;
      padding: 0.75rem 1rem;
      border-radius: var(--radius-md);
    }

    .nav-link.active::after {
      display: none;
    }
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .logo-link:hover {
      transform: none;
    }

    .theme-toggle:active {
      transform: none;
    }

    .nav-links[data-menu-open='true'] {
      animation: none;
    }
  }
</style>

<script is:inline>
  (function() {
    const THEME_KEY = 'speck-theme';

    function getStoredPreference() {
      try {
        const stored = localStorage.getItem(THEME_KEY);
        if (stored) {
          const parsed = JSON.parse(stored);
          if (parsed.preference === 'light' || parsed.preference === 'dark' || parsed.preference === 'system') {
            return parsed.preference;
          }
        }
      } catch (e) {
        // Ignore parse errors
      }
      return 'system';
    }

    function applyTheme(preference) {
      const root = document.documentElement;

      // Set the preference attribute (for icon display)
      if (preference === 'system') {
        root.removeAttribute('data-theme-preference');
      } else {
        root.setAttribute('data-theme-preference', preference);
      }

      // Set the actual theme (for colors)
      if (preference === 'system') {
        root.removeAttribute('data-theme');
      } else {
        root.setAttribute('data-theme', preference);
      }

      // Store the preference
      localStorage.setItem(THEME_KEY, JSON.stringify({ preference: preference }));

      // Update button title
      const toggle = document.querySelector('[data-theme-toggle]');
      if (toggle) {
        const labels = {
          system: 'Theme: System (click for Light)',
          light: 'Theme: Light (click for Dark)',
          dark: 'Theme: Dark (click for System)',
        };
        toggle.setAttribute('title', labels[preference]);
      }
    }

    function cycleTheme() {
      const current = getStoredPreference();
      const next = current === 'system' ? 'light' : current === 'light' ? 'dark' : 'system';
      applyTheme(next);
    }

    function initTheme() {
      const preference = getStoredPreference();
      applyTheme(preference);

      // Listen for system theme changes (only add once)
      if (!window._speckThemeListenerAdded) {
        window._speckThemeListenerAdded = true;
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function() {
          if (getStoredPreference() === 'system') {
            applyTheme('system');
          }
        });
      }
    }

    function closeMenu() {
      var menuToggle = document.querySelector('[data-mobile-menu-toggle]');
      var navLinks = document.querySelector('[data-nav-links]');
      if (menuToggle && navLinks) {
        menuToggle.setAttribute('aria-expanded', 'false');
        navLinks.removeAttribute('data-menu-open');
      }
    }

    function toggleMenu() {
      var menuToggle = document.querySelector('[data-mobile-menu-toggle]');
      var navLinks = document.querySelector('[data-nav-links]');
      if (!menuToggle || !navLinks) return;

      var isOpen = navLinks.hasAttribute('data-menu-open');
      if (isOpen) {
        menuToggle.setAttribute('aria-expanded', 'false');
        navLinks.removeAttribute('data-menu-open');
      } else {
        menuToggle.setAttribute('aria-expanded', 'true');
        navLinks.setAttribute('data-menu-open', 'true');
      }
    }

    // Single document click handler using event delegation (only add once)
    if (!window._speckClickHandlerAdded) {
      window._speckClickHandlerAdded = true;

      document.addEventListener('click', function(e) {
        var target = e.target;

        // Theme toggle
        var themeToggle = target.closest('[data-theme-toggle]');
        if (themeToggle) {
          e.preventDefault();
          cycleTheme();
          return;
        }

        // Mobile menu toggle
        var mobileToggle = target.closest('[data-mobile-menu-toggle]');
        if (mobileToggle) {
          e.preventDefault();
          toggleMenu();
          return;
        }

        // Close menu when clicking nav links
        var navLink = target.closest('.nav-link');
        var navLinks = document.querySelector('[data-nav-links]');
        if (navLink && navLinks && navLinks.contains(navLink)) {
          closeMenu();
          return;
        }

        // Close menu when clicking outside
        var menuToggle = document.querySelector('[data-mobile-menu-toggle]');
        navLinks = document.querySelector('[data-nav-links]');
        if (menuToggle && navLinks && navLinks.hasAttribute('data-menu-open')) {
          if (!menuToggle.contains(target) && !navLinks.contains(target)) {
            closeMenu();
          }
        }
      });
    }

    // Run immediately on every page load/navigation
    closeMenu();
    initTheme();

    // Handle View Transitions - only add listener once
    if (!window._speckAstroListenersAdded) {
      window._speckAstroListenersAdded = true;

      document.addEventListener('astro:page-load', function() {
        closeMenu();
        initTheme();
      });
    }
  })();
</script>
