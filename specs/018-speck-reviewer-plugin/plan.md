# Implementation Plan: Speck Reviewer Plugin

**Branch**: `018-speck-reviewer-plugin` | **Date**: 2025-12-07 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/018-speck-reviewer-plugin/spec.md`

## Summary

Extract PR review functionality from `claude-pr-review-extensions-poc` into a standalone Claude Code plugin. The plugin provides AI-powered code review with structured cluster-based walkthroughs, Speck-aware context loading, and GitHub integration via the `gh` CLI. This creates a monorepo structure supporting independent installation of both the main Speck plugin and the new speck-reviewer plugin.

## Technical Context

**Language/Version**: TypeScript 5.3+ with Bun 1.0+ runtime
**Primary Dependencies**: Bun Shell API, `gh` CLI (user-provided)
**Storage**: File-based JSON (`.claude/review-state.json`)
**Testing**: Bun test runner
**Target Platform**: macOS/Linux terminal (Claude Code environment)
**Project Type**: Single project with monorepo plugin structure
**Performance Goals**: CLI commands respond in <500ms, clustering <2s for 100 files
**Constraints**: No external npm dependencies beyond Bun builtins
**Scale/Scope**: PRs up to 200 files, review sessions up to 50 comments

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Upstream Fidelity | N/A | New plugin, not spec-kit derived |
| II. Extension Preservation | N/A | No upstream to sync |
| III. Specification-First | ✅ | Spec written first, plan follows |
| IV. Quality Gates | ✅ | Will use preflight validation |
| V. Claude Code Native | ✅ | Slash commands, skills, CLI integration |
| VI. Technology Agnosticism | ✅ | Spec has no implementation details |
| VII. File Format Compatibility | N/A | Plugin uses own state format |
| VIII. Command-Implementation Separation | ✅ | Commands delegate to CLI scripts |
| IX. Preflight Gate | ✅ | Will run `bun preflight` before completion |
| X. Website Documentation | ✅ | REQUIRED: New plugin pages for extensibility and speck-reviewer (T061-T063) |
| XI. TDD | ✅ | Tests before implementation |
| XII. Documentation Skill Sync | ✅ | REQUIRED: Update speck-help with plugin extensibility info (T064) |

## Project Structure

### Documentation (this feature)

```text
specs/018-speck-reviewer-plugin/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # Technology decisions
├── data-model.md        # Entity definitions
├── quickstart.md        # Developer setup
├── contracts/           # API contracts
│   ├── cli-commands.md  # CLI interface
│   └── plugin-manifest.md # Plugin structure
└── tasks.md             # Generated by /speck:tasks
```

### Source Code (repository root)

```text
# Monorepo plugin structure
.claude-plugin/
└── marketplace.json          # Root marketplace (lists both plugins)

plugins/
├── speck/                    # Existing speck plugin (migrated)
│   ├── .claude-plugin/
│   │   └── plugin.json
│   ├── commands/
│   ├── skills/
│   ├── agents/
│   └── .speck/               # Speck scripts
│
└── speck-reviewer/           # New plugin (this feature)
    ├── .claude-plugin/
    │   └── plugin.json
    ├── commands/
    │   └── review.md
    ├── skills/
    │   └── pr-review/
    │       └── SKILL.md
    └── cli/
        ├── src/
        │   ├── index.ts      # CLI entry point
        │   ├── state.ts      # Session persistence
        │   ├── clustering.ts # File clustering
        │   ├── github.ts     # GitHub operations
        │   ├── speck.ts      # Speck integration
        │   └── logger.ts     # Logging utilities
        ├── dist/
        │   └── speck-review  # Compiled CLI
        ├── package.json
        └── tsconfig.json

tests/
├── unit/
│   ├── state.test.ts
│   ├── clustering.test.ts
│   └── speck.test.ts
└── integration/
    └── cli-workflow.test.ts
```

**Structure Decision**: Monorepo with plugins/ directory. Each plugin is self-contained with own .claude-plugin/ manifest. Root marketplace.json references both plugins.

## Testing Strategy

### Coverage Requirements

- **Unit tests**: 80% line coverage for CLI modules
- **Integration tests**: Full CLI command workflow
- **Critical paths**: 100% coverage for state persistence, comment posting

### Test Organization

| Phase | Test Type | Files |
|-------|-----------|-------|
| Phase 1 | Unit | state.test.ts, clustering.test.ts |
| Phase 2 | Unit | github.test.ts, speck.test.ts |
| Phase 3 | Integration | cli-workflow.test.ts |

### Test Fixtures

- Mock GitHub API responses for offline testing
- Sample PR diffs for clustering tests
- Sample Speck specs for context loading tests

## Implementation Phases

### Phase 1: Repository Restructure & Core CLI (P1)

**Goal**: Migrate to monorepo structure and extract core CLI from POC.

**Tasks**:
1. Create plugins/ directory structure
2. Migrate existing speck plugin to plugins/speck/
3. Create speck-reviewer plugin scaffold
4. Extract state.ts from POC (full extraction)
5. Extract clustering.ts from POC (full extraction)
6. Extract logger.ts from POC
7. Create CLI entry point (index.ts)
8. Add unit tests for state management
9. Add unit tests for clustering

**Dependencies**: None (foundational)

**Acceptance**:
- `bun test` passes for state and clustering modules
- CLI responds to `help` command

### Phase 2: GitHub Integration & Commands (P1)

**Goal**: Implement GitHub operations and all CLI commands.

**Tasks**:
1. Extract github.ts from POC (PR operations)
2. Implement `analyze` command
3. Implement `comment` commands (add, reply, delete, list)
4. Implement `review` command (approve, request-changes, comment)
5. Implement `files` command
6. Implement `state` command (show, clear)
7. Implement `check-self-review` command
8. Add error handling with retry support
9. Add unit tests for GitHub operations (mocked)

**Dependencies**: Phase 1 complete

**Acceptance**:
- All CLI commands work with authenticated `gh` CLI
- Error messages are actionable
- Comments can be posted and listed

### Phase 3: Speck Integration (P1)

**Goal**: Load Speck specs for feature branches.

**Tasks**:
1. Implement spec detection (check specs/ and .speck/branches.json)
2. Implement spec parsing (extract requirements, user stories)
3. Implement `spec-context` command
4. Integrate spec context into analyze output
5. Add unit tests for spec detection
6. Test graceful degradation when no spec exists

**Dependencies**: Phase 1 complete

**Acceptance**:
- Spec context loads for branches with specs
- Review proceeds normally without spec (FR-022)

### Phase 4: Plugin & Skill (P2)

**Goal**: Create Claude Code plugin with skill and command.

**Tasks**:
1. Create plugin.json manifest for speck-reviewer
2. Create /review command (review.md)
3. Migrate and adapt SKILL.md from POC
4. Update root marketplace.json
5. Test plugin installation locally
6. Test coexistence with speck plugin

**Dependencies**: Phases 2-3 complete

**Acceptance**:
- `/review` command works in Claude Code
- Both plugins install without conflicts (SC-006)

### Phase 5: Polish & Documentation (P2-P3)

**Goal**: Final quality pass and documentation.

**Tasks**:
1. Run `bun preflight` and fix any issues
2. Add integration tests for full workflow
3. Update CLAUDE.md with new plugin info
4. Test all user stories end-to-end
5. Verify website needs (if any user-facing docs required)

**Dependencies**: Phase 4 complete

**Acceptance**:
- `bun preflight` passes with 0 introduced failures
- All acceptance scenarios from spec pass manually

## Risk Mitigation

| Risk | Mitigation |
|------|------------|
| POC code needs significant changes | POC is already working; extraction is mechanical |
| gh CLI version incompatibility | Document minimum version, test with common versions |
| Large PRs slow clustering | Heuristic clustering is O(n), tested up to 200 files |
| State corruption | Atomic writes, schema versioning, clear error recovery |

## Documentation Impact

Per Constitution Principles X and XII, this feature REQUIRES documentation updates:

- **Website** (REQUIRED):
  - New section: `plugins/index.md` - Describes Speck's optional plugin architecture
  - New page: `plugins/speck-reviewer.md` - Installation and usage guide for speck-reviewer
  - Navigation update: Add "Plugins" section to website navigation
- **README**: Update to mention monorepo structure and both plugins
- **speck-help skill** (REQUIRED): Update to document plugin extensibility (speck-reviewer is the first optional plugin)

## Complexity Tracking

> No constitutional violations requiring justification.

| Item | Decision | Rationale |
|------|----------|-----------|
| Monorepo structure | Required | FR-001 mandates multiple plugins with shared marketplace |
| Two plugins | Required | FR-003 mandates independent installation |
| File-based state | Chosen over SQLite | Simpler, matches POC, sufficient for use case |

## Next Steps

Run `/speck:tasks` to generate detailed task list with test-first ordering.
