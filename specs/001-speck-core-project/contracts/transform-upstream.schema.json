{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://speck.dev/schemas/transform-upstream.json",
  "title": "Transform Upstream Command Contract",
  "description": "Contract for the /speck.transform-upstream command - syncs upstream spec-kit changes via AI-driven semantic transformation",
  "type": "object",
  "properties": {
    "input": {
      "type": "object",
      "description": "Input parameters for upstream synchronization",
      "properties": {
        "targetCommit": {
          "type": ["string", "null"],
          "description": "Optional target upstream commit SHA (defaults to latest)",
          "pattern": "^[a-f0-9]{40}$"
        },
        "dryRun": {
          "type": "boolean",
          "description": "Preview changes without applying them",
          "default": false
        }
      }
    },
    "output": {
      "type": "object",
      "description": "Output from successful upstream sync",
      "properties": {
        "syncReport": {
          "type": "object",
          "description": "Synchronization report metadata",
          "properties": {
            "reportPath": {
              "type": "string",
              "description": "Path to generated sync report markdown file",
              "pattern": "^\\.speck/sync-reports/.*-report\\.md$"
            },
            "upstreamCommitsAnalyzed": {
              "type": "integer",
              "description": "Number of upstream commits analyzed",
              "minimum": 0
            },
            "filesModified": {
              "type": "integer",
              "description": "Number of Speck files modified",
              "minimum": 0
            },
            "extensionsPreserved": {
              "type": "object",
              "description": "Extension preservation statistics",
              "properties": {
                "total": {
                  "type": "integer",
                  "description": "Total number of extension markers",
                  "minimum": 0
                },
                "preserved": {
                  "type": "integer",
                  "description": "Number of extensions successfully preserved",
                  "minimum": 0
                },
                "preservationRate": {
                  "type": "number",
                  "description": "Percentage of extensions preserved (must be 100%)",
                  "const": 100.0
                }
              },
              "required": ["total", "preserved", "preservationRate"]
            },
            "conflictsDetected": {
              "type": "integer",
              "description": "Number of conflicts requiring human resolution",
              "minimum": 0
            },
            "automaticResolutions": {
              "type": "integer",
              "description": "Number of changes applied automatically",
              "minimum": 0
            }
          },
          "required": [
            "reportPath",
            "upstreamCommitsAnalyzed",
            "filesModified",
            "extensionsPreserved",
            "conflictsDetected",
            "automaticResolutions"
          ]
        },
        "changesApplied": {
          "type": "array",
          "description": "List of files successfully modified",
          "items": {
            "type": "object",
            "properties": {
              "filePath": {
                "type": "string",
                "description": "Path to modified file"
              },
              "changeType": {
                "type": "string",
                "description": "Type of modification",
                "enum": ["modified", "added", "deleted"]
              },
              "confidenceScore": {
                "type": "number",
                "description": "AI transformation confidence (0.0-1.0)",
                "minimum": 0.0,
                "maximum": 1.0
              },
              "reasoning": {
                "type": "string",
                "description": "Chain-of-thought explanation for transformation"
              },
              "preservedExtensions": {
                "type": "array",
                "description": "Extension markers preserved in this file",
                "items": {
                  "type": "object",
                  "properties": {
                    "name": {
                      "type": "string",
                      "description": "Extension marker name"
                    },
                    "preserved": {
                      "type": "boolean",
                      "description": "Whether extension was successfully preserved",
                      "const": true
                    }
                  },
                  "required": ["name", "preserved"]
                }
              }
            },
            "required": ["filePath", "changeType", "confidenceScore", "reasoning", "preservedExtensions"]
          }
        },
        "conflictsRequiringResolution": {
          "type": "array",
          "description": "List of conflicts requiring user intervention",
          "items": {
            "type": "object",
            "properties": {
              "filePath": {
                "type": "string",
                "description": "Path to conflicting file"
              },
              "upstreamChange": {
                "type": "string",
                "description": "Description of upstream change"
              },
              "speckExtension": {
                "type": "string",
                "description": "Description of Speck extension conflict"
              },
              "resolutionOptions": {
                "type": "array",
                "description": "Available resolution strategies",
                "items": {
                  "type": "string",
                  "enum": ["skip", "manual_merge", "abort_sync"]
                },
                "minItems": 3,
                "maxItems": 3
              }
            },
            "required": ["filePath", "upstreamChange", "speckExtension", "resolutionOptions"]
          }
        },
        "upstreamTracker": {
          "type": "object",
          "description": "Updated upstream tracker state",
          "properties": {
            "lastSyncedCommit": {
              "type": "string",
              "description": "SHA of last synced upstream commit",
              "pattern": "^[a-f0-9]{40}$"
            },
            "lastSyncDate": {
              "type": "string",
              "description": "ISO 8601 timestamp of sync completion",
              "format": "date-time"
            },
            "status": {
              "type": "string",
              "description": "Overall sync status",
              "enum": ["synced", "conflict"]
            }
          },
          "required": ["lastSyncedCommit", "lastSyncDate", "status"]
        }
      },
      "required": ["syncReport", "changesApplied", "conflictsRequiringResolution", "upstreamTracker"]
    },
    "errors": {
      "type": "object",
      "description": "Possible error cases",
      "properties": {
        "TYPE_CHECK_FAILED": {
          "type": "object",
          "description": "Error when transformed code fails TypeScript type checking",
          "properties": {
            "code": {
              "type": "string",
              "const": "TYPE_CHECK_FAILED"
            },
            "message": {
              "type": "string",
              "pattern": "^Transformed code failed type checking\\. Sync aborted\\. See errors below:.*"
            },
            "typeErrors": {
              "type": "array",
              "description": "List of TypeScript errors",
              "items": {
                "type": "string"
              }
            },
            "exitCode": {
              "type": "integer",
              "const": 1
            }
          }
        },
        "TEST_FAILED": {
          "type": "object",
          "description": "Error when transformed code fails test suite",
          "properties": {
            "code": {
              "type": "string",
              "const": "TEST_FAILED"
            },
            "message": {
              "type": "string",
              "pattern": "^Transformed code failed tests\\. Sync aborted\\. See test failures below:.*"
            },
            "testFailures": {
              "type": "array",
              "description": "List of test failures",
              "items": {
                "type": "string"
              }
            },
            "exitCode": {
              "type": "integer",
              "const": 1
            }
          }
        },
        "EXTENSION_VIOLATION": {
          "type": "object",
          "description": "Critical error when extension marker would be modified (should never occur)",
          "properties": {
            "code": {
              "type": "string",
              "const": "EXTENSION_VIOLATION"
            },
            "message": {
              "type": "string",
              "pattern": "^CRITICAL: Transformation attempted to modify content within \\[SPECK-EXTENSION\\] markers\\. This violates Constitution II\\. Sync aborted\\.$"
            },
            "violatedExtensions": {
              "type": "array",
              "description": "List of extension markers that would be violated",
              "items": {
                "type": "object",
                "properties": {
                  "name": {
                    "type": "string"
                  },
                  "filePath": {
                    "type": "string"
                  }
                },
                "required": ["name", "filePath"]
              }
            },
            "exitCode": {
              "type": "integer",
              "const": 2
            }
          }
        },
        "BREAKING_CHANGE_DETECTED": {
          "type": "object",
          "description": "Warning when breaking changes conflict with Speck architecture",
          "properties": {
            "code": {
              "type": "string",
              "const": "BREAKING_CHANGE_DETECTED"
            },
            "message": {
              "type": "string",
              "pattern": "^Upstream sync detected breaking changes that conflict with Speck's architecture\\. Review conflicts and choose resolution strategy\\.$"
            },
            "breakingChanges": {
              "type": "array",
              "description": "List of detected breaking changes",
              "items": {
                "type": "object",
                "properties": {
                  "description": {
                    "type": "string",
                    "description": "Description of breaking change"
                  },
                  "affectedWorkflows": {
                    "type": "array",
                    "description": "Speck workflows impacted",
                    "items": {
                      "type": "string"
                    }
                  }
                },
                "required": ["description", "affectedWorkflows"]
              }
            }
          }
        }
      }
    }
  },
  "required": ["input", "output", "errors"]
}
