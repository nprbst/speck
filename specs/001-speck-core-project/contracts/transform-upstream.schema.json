{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://speck.dev/schemas/commands/transform-upstream.json",
  "title": "Transform Upstream Command Contract",
  "description": "Contract for the /speck.transform-upstream command - syncs upstream spec-kit changes via Claude agent",
  "type": "object",
  "properties": {
    "command": {
      "type": "string",
      "const": "transform-upstream",
      "description": "Command name"
    },
    "input": {
      "type": "object",
      "properties": {
        "commandName": {
          "type": "string",
          "enum": ["specify", "clarify", "plan", "tasks", "implement", "analyze", "constitution", "checklist", "all"],
          "description": "Which command to transform (or 'all' for all commands)"
        },
        "upstreamVersion": {
          "type": "string",
          "pattern": "^v\\d+\\.\\d+\\.\\d+$",
          "description": "Specific upstream version to sync to (optional, defaults to latest)"
        },
        "dryRun": {
          "type": "boolean",
          "default": false,
          "description": "Show what would change without applying"
        },
        "skipValidation": {
          "type": "boolean",
          "default": false,
          "description": "Skip TypeScript type checking and tests after transformation"
        }
      },
      "required": ["commandName"],
      "additionalProperties": false
    },
    "output": {
      "type": "object",
      "properties": {
        "upstreamInfo": {
          "type": "object",
          "properties": {
            "previousVersion": { "type": "string" },
            "newVersion": { "type": "string" },
            "commitSha": { "type": "string" },
            "releaseDate": { "type": "string", "format": "date-time" }
          },
          "required": ["previousVersion", "newVersion", "commitSha"]
        },
        "filesAnalyzed": {
          "type": "integer",
          "minimum": 1,
          "description": "Number of upstream bash scripts analyzed"
        },
        "filesModified": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of Speck TypeScript files modified"
        },
        "extensionsPreserved": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of [SPECK-EXTENSION] blocks preserved"
        },
        "confidence": {
          "type": "string",
          "enum": ["high", "medium", "low"],
          "description": "Claude's confidence level in transformations"
        },
        "changes": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "file": { "type": "string" },
              "description": { "type": "string" },
              "diff": { "type": "string" }
            },
            "required": ["file", "description"]
          }
        },
        "reviewRequired": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "file": { "type": "string" },
              "reason": { "type": "string" }
            },
            "required": ["file", "reason"]
          },
          "description": "Files requiring manual review (low confidence)"
        },
        "validation": {
          "type": "object",
          "properties": {
            "typeCheck": {
              "type": "object",
              "properties": {
                "passed": { "type": "boolean" },
                "errors": { "type": "array", "items": { "type": "string" } }
              },
              "required": ["passed", "errors"]
            },
            "tests": {
              "type": "object",
              "properties": {
                "passed": { "type": "boolean" },
                "skipped": { "type": "boolean" },
                "failures": { "type": "array", "items": { "type": "string" } }
              },
              "required": ["passed", "skipped"]
            }
          },
          "required": ["typeCheck", "tests"]
        },
        "syncReport": {
          "type": "object",
          "properties": {
            "filePath": { "type": "string" },
            "url": { "type": "string", "format": "uri" }
          },
          "required": ["filePath"],
          "description": "Path to generated sync report markdown"
        },
        "nextSteps": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Suggested next actions"
        }
      },
      "required": [
        "upstreamInfo",
        "filesAnalyzed",
        "filesModified",
        "extensionsPreserved",
        "confidence",
        "changes",
        "validation",
        "syncReport",
        "nextSteps"
      ]
    },
    "errors": {
      "type": "object",
      "properties": {
        "upstreamNotAvailable": {
          "type": "object",
          "properties": {
            "code": { "type": "string", "const": "UPSTREAM_NOT_AVAILABLE" },
            "message": { "type": "string" },
            "upstreamUrl": { "type": "string" }
          }
        },
        "extensionConflict": {
          "type": "object",
          "properties": {
            "code": { "type": "string", "const": "EXTENSION_CONFLICT" },
            "message": { "type": "string" },
            "conflictedFile": { "type": "string" },
            "conflictedExtension": { "type": "string" }
          }
        },
        "validationFailed": {
          "type": "object",
          "properties": {
            "code": { "type": "string", "const": "VALIDATION_FAILED" },
            "message": { "type": "string" },
            "validationType": { "type": "string", "enum": ["typeCheck", "tests"] },
            "errors": { "type": "array", "items": { "type": "string" } }
          }
        }
      }
    }
  },
  "required": ["command", "input", "output"],
  "examples": [
    {
      "command": "transform-upstream",
      "input": {
        "commandName": "clarify"
      },
      "output": {
        "upstreamInfo": {
          "previousVersion": "v0.0.85",
          "newVersion": "v0.0.86",
          "commitSha": "abc123def456",
          "releaseDate": "2025-11-13T00:00:00Z"
        },
        "filesAnalyzed": 1,
        "filesModified": 2,
        "extensionsPreserved": 3,
        "confidence": "high",
        "changes": [
          {
            "file": ".claude/commands/speck.clarify.md",
            "description": "Enhanced ambiguity detection taxonomy from upstream",
            "diff": "..."
          },
          {
            "file": ".claude/agents/clarification-agent.md",
            "description": "Updated agent instructions with new taxonomy",
            "diff": "..."
          }
        ],
        "reviewRequired": [],
        "validation": {
          "typeCheck": {
            "passed": true,
            "errors": []
          },
          "tests": {
            "passed": true,
            "skipped": false,
            "failures": []
          }
        },
        "syncReport": {
          "filePath": ".speck/sync-reports/2025-11-14-clarify.md"
        },
        "nextSteps": [
          "Review changes: git diff .claude/",
          "Commit if satisfied: git commit -m 'sync: transform clarify from spec-kit v0.0.86'"
        ]
      }
    }
  ]
}
