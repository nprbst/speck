# Implementation Plan: Atomic Transform Rollback

**Branch**: `016-atomic-transform-rollback` | **Date**: 2025-11-30 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/016-atomic-transform-rollback/spec.md`

## Summary

Implement staged transformation with atomic rollback for the transform-upstream command. Currently, Agent 1 (script transformation) and Agent 2 (command transformation) write directly to production directories. If Agent 2 fails after Agent 1 completes, the system is left in an inconsistent state with transformed scripts but outdated commands. This feature introduces a staging directory pattern (`.speck/.transform-staging/<version>/`) where both agents write to isolated subdirectories. Only after both agents succeed are files atomically moved to production. On any failure, the staging directory is deleted, preserving production state.

## Technical Context

**Language/Version**: TypeScript 5.3+ with Bun 1.0+ runtime
**Primary Dependencies**: Bun Shell API (file operations), Zod (validation)
**Storage**: File-based (`.speck/` directory, JSON metadata, Markdown artifacts)
**Testing**: Bun test with fixtures
**Target Platform**: macOS, Linux (POSIX atomic rename semantics required)
**Project Type**: Single project (CLI scripts)
**Performance Goals**: N/A (transformation is not latency-sensitive)
**Constraints**: Must preserve existing transformation history format; POSIX-compliant file operations
**Scale/Scope**: Single-user CLI tool, transformations typically involve <100 files

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Upstream Fidelity | PASS | This is a Speck-specific enhancement (no upstream equivalent); will use extension markers |
| II. Extension Preservation | PASS | All new code will be wrapped in `[SPECK-EXTENSION:START/END]` markers |
| III. Specification-First | PASS | Feature spec created with user scenarios, requirements, success criteria |
| V. Claude Code Native | PASS | Works with existing slash command and agent architecture |
| VII. File Format Compatibility | PASS | No changes to `specs/` directory format |
| VIII. Command-Implementation Separation | PASS | New staging logic will be implemented in TypeScript scripts, not inline in commands |
| IX. Preflight Gate | PASS | Will run `bun preflight` before completion |
| X. Website Documentation | N/A | Internal infrastructure change, no user-facing workflow changes |
| XI. TDD | PASS | Tests will be written before implementation |
| XII. Skill Documentation | N/A | No new commands or workflow changes for users |

## Project Structure

### Documentation (this feature)

```text
specs/016-atomic-transform-rollback/
├── plan.md              # This file
├── research.md          # Phase 0 output (if needed)
├── data-model.md        # Phase 1 output - entity definitions
├── quickstart.md        # Phase 1 output - developer setup
└── tasks.md             # Phase 2 output (generated by /speck:tasks)
```

### Source Code (repository root)

```text
.speck/
├── scripts/
│   ├── common/
│   │   ├── file-ops.ts              # Existing - may need minor extensions
│   │   ├── transformation-history.ts # Existing - add staging states
│   │   └── staging-manager.ts       # NEW - staging lifecycle management
│   └── transform-upstream/
│       └── index.ts                 # NEW - orchestration logic extracted from command

.claude/
├── commands/
│   └── speck.transform-upstream.md  # Existing - modify to use staging
└── agents/
    ├── speck.transform-bash-to-bun.md   # Existing - no changes needed
    └── speck.transform-commands.md      # Existing - no changes needed

tests/
├── unit/
│   └── staging-manager.test.ts      # NEW - staging lifecycle tests
└── integration/
    └── transform-rollback.test.ts   # NEW - end-to-end rollback scenarios
```

**Structure Decision**: Single project structure with scripts in `.speck/scripts/`. New staging manager module in `common/` directory, integration tests in `tests/`.

## Testing Strategy

**TDD Approach**: Red-green-refactor at task level

**Test Fixtures**:
- Mock upstream release directory with transformable scripts/commands
- Pre-populated staging directories for orphan recovery tests
- Mock file system operations for failure injection

**Coverage Targets**:
- Unit tests: 100% of `staging-manager.ts` public functions
- Integration tests: All 4 user stories with acceptance scenarios
- Critical paths: Rollback on Agent 2 failure, orphan detection and recovery

**Test Isolation**:
- Use temporary directories for all staging operations in tests
- Clean up after each test to prevent cross-test contamination
- Mock transformation history to avoid polluting real tracking files

## Implementation Phases

### Phase 1: Staging Infrastructure (Core)

1. Create `StagingContext` and `StagedFile` types in staging-manager.ts
2. Implement `createStagingDirectory(version)` function
3. Implement `listStagedFiles(context)` function
4. Implement `commitStaging(context)` with atomic moves
5. Implement `rollbackStaging(context)` with directory cleanup
6. Implement `detectOrphanedStaging()` function

### Phase 2: Orphan Recovery (US3)

1. Implement `getStagingStatus(directory)` to determine completion state
2. Implement `promptForRecovery(directory)` interactive handler
3. Implement `inspectStaging(context)` to display staging contents
4. Add orphan detection check at transform-upstream startup

### Phase 3: Command Integration (US1, US2, US4)

1. Modify transform-upstream command to create staging context
2. Update Agent 1 invocation to use staging OUTPUT_DIR
3. Update Agent 2 invocation to use staging OUTPUT_DIR
4. Add commit logic after both agents succeed
5. Add rollback logic on any agent failure
6. Add file conflict detection before commit (FR-012)

### Phase 4: Status & Reporting (FR-008, FR-011)

1. Extend transformation history with staging states
2. Add file manifest reporting before commit
3. Add error details to failed transformation status
4. Add conflict warnings for modified production files

## Key Technical Decisions

### Staging Directory Structure

```text
.speck/.transform-staging/<version>/
├── staging.json          # Metadata: start time, status, target version
├── scripts/              # Agent 1 output destination
│   └── *.ts
├── commands/             # Agent 2 output destination
│   └── speck.*.md
├── agents/               # Agent 2 factored agents
│   └── speck.*.md
└── skills/               # Agent 2 factored skills
    └── speck.*.md
```

### Atomic Commit Strategy

Use POSIX `rename()` semantics (via `fs.rename()` or Bun equivalent) which are atomic on the same filesystem. The commit sequence:

1. Verify staging directory exists and metadata shows "ready"
2. List all files to be committed (FR-011)
3. Check for file conflicts (FR-012)
4. For each subdirectory (scripts, commands, agents, skills):
   - Move files individually with atomic rename
   - Track moved files for potential partial rollback
5. Update transformation status to "transformed"
6. Remove staging directory

### Rollback Strategy

On failure or explicit rollback request:
1. Delete entire staging directory tree recursively
2. Update transformation status to "failed" with error message
3. No production files touched

### File Conflict Detection

Before commit, check each production file that will be overwritten:
1. Record production file mtimes at staging start
2. At commit time, compare current mtimes to recorded values
3. If any file changed, warn user with option to proceed or abort

## Documentation Impact

- **Website**: N/A - This is internal infrastructure, no user-facing workflow changes
- **Skill**: N/A - No new commands or workflow artifacts for users to learn

## Complexity Tracking

No constitution violations requiring justification.

## Dependencies

- Existing `file-ops.ts` module for atomic operations
- Existing `transformation-history.ts` module for status tracking
- Existing agent definitions (no modifications needed to agents)

## Risks & Mitigations

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Cross-filesystem moves fail | Low | High | Detect and fall back to copy+delete |
| Disk space exhaustion during staging | Low | Medium | Pre-check available space before staging |
| Race condition on staging directory | Very Low | Medium | Use unique version-based directory names |
